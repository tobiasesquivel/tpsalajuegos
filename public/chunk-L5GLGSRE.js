import{d}from"./chunk-GLJWXLRS.js";import{a as f}from"./chunk-HXP6K52P.js";import{K as p,P as l}from"./chunk-AOP3JIL5.js";import{a as u,b as c,i as s}from"./chunk-ODN5LVDJ.js";var h=class t{constructor(e,r){this.supabaseService=e;this.router=r;this.supabase=e.getCliente(),this.inicializarUsuario()}supabase;usuarioActual=null;inicializarUsuario(){return s(this,null,function*(){let e=yield this.supabaseService.getSession();if(e?.user){let{data:r}=yield this.supabase.from("usuarios").select("*").eq("id",e.user.id).single();r&&(this.usuarioActual=c(u({},r),{email:e.user.email}))}})}registrar(e,r,i){return s(this,null,function*(){try{let{data:a,error:o}=yield this.supabase.from("usuarios").select("id").eq("nombreusuario",r).maybeSingle();if(o)return console.error("Error al verificar usuario existente:",o),{error:{message:"Error al verificar usuario existente"}};if(a)return{error:{message:"El nombre de usuario ya est\xE1 en uso"}};let{data:m,error:n}=yield this.supabase.auth.signUp({email:e,password:i,options:{data:{nombreusuario:r}}});if(n)return console.error("Error en signUp:",n),{error:n};if(!m.user)return{error:{message:"Error al crear el usuario"}};let{error:g}=yield this.supabase.from("usuarios").insert({id:m.user.id,nombreusuario:r,fecha_registro:new Date().toISOString(),es_admin:!1});return g?(console.error("Error al insertar usuario:",g),{error:{message:"Error al crear el perfil de usuario"}}):(this.router.navigate(["/login"]),{error:null})}catch(a){return console.error("Error en el registro:",a),{error:{message:"Error inesperado durante el registro"}}}})}iniciarSesion(e,r){return s(this,null,function*(){try{let{data:i,error:a}=yield this.supabase.auth.signInWithPassword({email:e,password:r});if(a)return a.message.includes("Email not confirmed")?{error:{message:"Por favor, confirma tu correo electr\xF3nico antes de iniciar sesi\xF3n."}}:{error:a};if(i.user){let{data:o}=yield this.supabase.from("usuarios").select("*").eq("id",i.user.id).single();o&&(this.usuarioActual=c(u({},o),{email:i.user.email})),yield this.supabase.from("logs_ingreso").insert({usuario_id:i.user.id,fecha_ingreso:new Date().toISOString()}),this.router.navigate(["/home"])}return{error:null}}catch(i){return console.error("Error en el inicio de sesi\xF3n:",i),{error:{message:"Error inesperado durante el inicio de sesi\xF3n"}}}})}reenviarConfirmacion(e){return s(this,null,function*(){try{let{error:r}=yield this.supabase.auth.resend({type:"signup",email:e,options:{emailRedirectTo:`${window.location.origin}/login`}});return r?{error:r}:{error:null,message:"Se ha reenviado el correo de confirmaci\xF3n. Por favor, revisa tu bandeja de entrada."}}catch(r){return console.error("Error al reenviar confirmaci\xF3n:",r),{error:{message:"Error al reenviar el correo de confirmaci\xF3n"}}}})}cerrarSesion(){return s(this,null,function*(){try{return(yield this.supabaseService.signOut())&&(this.usuarioActual=null,this.router.navigate(["/login"])),{error:null}}catch(e){return console.error("Error al cerrar sesi\xF3n:",e),{error:{message:"Error inesperado al cerrar sesi\xF3n"}}}})}obtenerUsuarioActual(){return this.usuarioActual}estaAutenticado(){return this.usuarioActual!==null}static \u0275fac=function(r){return new(r||t)(l(f),l(d))};static \u0275prov=p({token:t,factory:t.\u0275fac,providedIn:"root"})};export{h as a};
